<!DOCTYPE html>
<html>
<head>
    <title>Brand Seller Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script> <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 40px; background: #f4f7f6; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        .form-group { margin-bottom: 15px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        input, button { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background: #3ecf8e; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #36b37a; }
        #status { padding: 10px; margin-bottom: 20px; border-radius: 4px; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>Submit New Product</h2>
    <div id="status"></div>
    
    <div class="form-group">
        <label>Brand ID (Numeric)</label>
        <input type="number" id="p_brand_id" placeholder="Enter your Brand ID">
    </div>

    <div class="form-group">
        <label>Product Name</label>
        <input type="text" id="p_name" placeholder="E.g. Organic Face Wash">
    </div>

    <div class="form-group">
        <label>MRP (Price before discount)</label>
        <input type="number" id="p_mrp" placeholder="1500">
    </div>

    <div class="form-group">
        <label>Sale Price (Final price)</label>
        <input type="number" id="p_sale" placeholder="999">
    </div>

    <div class="form-group">
        <label>Product Images</label>
        <input type="file" id="p_images" multiple accept="image/*">
    </div>

    <button id="submitBtn" onclick="handleSubmit()">Upload & Submit for Review</button>
</div>

<script>
    // Initialize Supabase using config from config.js
    const supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    async function handleSubmit() {
        const btn = document.getElementById('submitBtn');
        const statusDiv = document.getElementById('status');
        
        // Form Values
        const brandId = document.getElementById('p_brand_id').value;
        const name = document.getElementById('p_name').value;
        const mrp = document.getElementById('p_mrp').value;
        const sale = document.getElementById('p_sale').value;
        const files = document.getElementById('p_images').files;

        if (!brandId || !name || !mrp || !sale || files.length === 0) {
            alert("Please fill all fields and select at least one image.");
            return;
        }

        // UI State
        btn.disabled = true;
        btn.innerText = "Processing...";
        statusDiv.style.display = "block";
        statusDiv.style.background = "#e1f5fe";
        statusDiv.innerText = "Uploading images to storage...";

        try {
            let uploadedPaths = [];

            // 1. Upload Images to Bucket
            for (let file of files) {
                const fileExt = file.name.split('.').pop();
                // UUID-style naming to prevent collisions
                const fileName = `${crypto.randomUUID()}.${fileExt}`;
                
                const { data, error: uploadError } = await supabase.storage
                    .from('brand-assets')
                    .upload(`products/${fileName}`, file);

                if (uploadError) throw uploadError;
                uploadedPaths.push(fileName);
            }

            // 2. Call the Database RPC function
            statusDiv.innerText = "Connecting to database...";
            const { data, error: rpcError } = await supabase.rpc('submit_new_product', {
                p_brand_id: parseInt(brandId),
                p_name: name,
                p_mrp: parseFloat(mrp),
                p_sale_price: parseFloat(sale),
                p_variants: [], // You can add variant logic later
                p_image_paths: uploadedPaths,
                p_details: { "description": "Submission via Dashboard", "timestamp": new Date().toISOString() }
            });

            if (rpcError) throw rpcError;

            // 3. Success
            statusDiv.style.background = "#d4edda";
            statusDiv.style.color = "#155724";
            statusDiv.innerText = "Success! Product submitted for review.";
            btn.innerText = "Submitted";
            
        } catch (err) {
            console.error(err);
            statusDiv.style.background = "#f8d7da";
            statusDiv.style.color = "#721c24";
            statusDiv.innerText = "Error: " + err.message;
            btn.disabled = false;
            btn.innerText = "Try Again";
        }
    }
</script>

</body>
</html>