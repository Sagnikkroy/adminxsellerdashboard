<!DOCTYPE html>
<html>
<head>
    <title>Seller Dashboard - Smart Submission</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script> 
    <style>
        :root { --primary: #3ecf8e; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; padding: 40px; background: var(--bg); color: #333; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 750px; margin: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .full { grid-column: span 2; }
        .section-box { grid-column: span 2; background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-top: 10px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 13px; color: #666; }
        input, textarea, select, button { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .step-row { display: flex; gap: 10px; margin-bottom: 8px; }
        .btn-add { background: #eef2ff; color: #4f46e5; border: 1px dashed #4f46e5; margin-bottom: 10px; cursor: pointer; padding: 8px; width: auto; font-size: 13px; }
        button#submitBtn { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 16px; }
        #status { padding: 12px; margin-bottom: 20px; border-radius: 6px; display: none; text-align: center; font-weight: bold; }
        .required { color: #ff4d4d; }
    </style>
</head>
<body>

<div class="card">
    <h2>Submit New Product</h2>
    <div id="status"></div>
    
    <div class="form-grid">
        <div class="form-group full">
            <label>Product Name <span class="required">*</span></label>
            <input type="text" id="p_name" placeholder="e.g. Ultra Hydrating Retinol Night Cream">
        </div>
        
        <div class="form-group">
            <label>Brand ID</label>
            <input type="number" id="p_brand_id" placeholder="e.g. 1024">
        </div>
        
        <div class="form-group">
            <label>Category</label>
            <select id="p_category" onchange="renderAttributes()">
                <option value="">Select Category</option>
                <option value="Skincare">Skincare</option>
                <option value="Haircare">Haircare</option>
                <option value="Makeup">Makeup</option>
            </select>
        </div>

        <div class="form-group"><label>MRP</label><input type="number" id="p_mrp" placeholder="e.g. 2500"></div>
        <div class="form-group"><label>Sale Price</label><input type="number" id="p_sale" placeholder="e.g. 1800"></div>
        <div class="form-group"><label>SKU</label><input type="text" id="p_sku" placeholder="e.g. BTY-CRM-01"></div>
        <div class="form-group"><label>Stock Quantity</label><input type="number" id="p_stock" placeholder="e.g. 100"></div>
        
        <div id="dynamic-section" class="section-box" style="display:none;">
            <label style="color:var(--primary)">Smart Filters (Metadata)</label>
            <div id="meta-container" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
        </div>

        <div class="section-box">
            <label>How to Use (Step-by-Step Instructions)</label>
            <div id="steps-container">
                <div class="step-row"><input type="text" class="step-input" placeholder="Step 1: Cleanse your face thoroughly..."></div>
            </div>
            <button type="button" class="btn-add" onclick="addStep()">+ Add Next Step</button>
        </div>

        <div class="form-group full">
            <label>Variants</label>
            <input type="text" id="p_variants" placeholder="e.g. Red, Blue, Green (Comma separated)">
        </div>

        <div class="form-group full">
            <label>Ingredients List</label>
            <textarea id="p_ingredients" rows="2" placeholder="e.g. Aqua, Glycerin, Niacinamide, Salicylic Acid (Comma separated)"></textarea>
        </div>

        <div class="form-group full">
            <label>Full Product Description</label>
            <textarea id="p_details" rows="3" placeholder="Tell us more about the product benefits and application..."></textarea>
        </div>
        
        <div class="form-group full">
            <label>Upload Images <span class="required">*</span></label>
            <input type="file" id="p_images" multiple accept="image/*">
        </div>
    </div>
    <button id="submitBtn" onclick="handleSubmit()">Submit for Review</button>
</div>

<script>
    const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    function addStep() {
        const container = document.getElementById('steps-container');
        const div = document.createElement('div');
        div.className = 'step-row';
        div.innerHTML = `<input type="text" class="step-input" placeholder="Next Step...">`;
        container.appendChild(div);
    }

    const attributeSchema = {
        "Skincare": ["Skin Type", "Concern", "Formulation", "Key Ingredient"],
        "Haircare": ["Scalp Type", "Hair Type", "Concern", "Formulation"],
        "Makeup": ["Finish", "Coverage", "Formulation", "Skin Type"]
    };

    function renderAttributes() {
        const cat = document.getElementById('p_category').value;
        const section = document.getElementById('dynamic-section');
        const container = document.getElementById('meta-container');
        container.innerHTML = '';
        if (attributeSchema[cat]) {
            section.style.display = "block";
            attributeSchema[cat].forEach(attr => {
                const key = attr.toLowerCase().replace(/ /g, '_');
                container.innerHTML += `<div><label>${attr}</label><input type="text" class="meta-input" data-key="${key}" placeholder="e.g. ${attr} details..."></div>`;
            });
        } else { section.style.display = "none"; }
    }

    async function handleSubmit() {
        const btn = document.getElementById('submitBtn');
        const statusDiv = document.getElementById('status');
        const name = document.getElementById('p_name').value;
        const files = document.getElementById('p_images').files;

        if (!name || files.length === 0) {
            alert("Product Name and at least one image are required!");
            return;
        }

        btn.disabled = true;
        statusDiv.style.display = "block";
        statusDiv.innerText = "Processing Submission...";

        try {
            const metadata = {};
            document.querySelectorAll('.meta-input').forEach(i => { if(i.value) metadata[i.dataset.key] = i.value; });

            const steps = Array.from(document.querySelectorAll('.step-input'))
                               .map(i => i.value.trim())
                               .filter(v => v !== "");

            let uploadedPaths = [];
            for (let file of files) {
                const fileName = `${Date.now()}_${file.name}`;
                await supabaseClient.storage.from('brand-assets').upload(`products/${fileName}`, file);
                uploadedPaths.push(fileName);
            }

            const { error } = await supabaseClient.rpc('submit_new_product', {
                p_brand_id: parseInt(document.getElementById('p_brand_id').value) || null,
                p_name: name,
                p_mrp: parseFloat(document.getElementById('p_mrp').value) || null,
                p_sale_price: parseFloat(document.getElementById('p_sale').value) || null,
                p_category: document.getElementById('p_category').value || null,
                p_sku: document.getElementById('p_sku').value || null,
                p_stock: parseInt(document.getElementById('p_stock').value) || 0,
                p_variants: { options: document.getElementById('p_variants').value.split(',').map(v => v.trim()).filter(v => v) },
                p_image_paths: uploadedPaths,
                p_details: { description: document.getElementById('p_details').value || "" },
                p_metadata: metadata,
                p_ingredients: document.getElementById('p_ingredients').value || "",
                p_how_to_use: { steps: steps }
            });

            if (error) throw error;
            statusDiv.innerText = "Submission Successful!";
            statusDiv.style.background = "#d1fae5";
        } catch (err) {
            statusDiv.innerText = "Error: " + err.message;
            statusDiv.style.background = "#fee2e2";
        } finally { btn.disabled = false; }
    }
</script>
</body>
</html>